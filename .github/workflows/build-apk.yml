name: 🎵 성경 MP3 플레이어 APK 빌드

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 수동 실행을 위한 중요한 설정!
    inputs:
      build_type:
        description: '빌드 타입을 선택하세요'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
    - name: 📥 소스코드 체크아웃
      uses: actions/checkout@v4

    - name: 🐍 Python 3.8 설정
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: ☕ Java 8 설정
      uses: actions/setup-java@v3
      with:
        distribution: 'adopt'
        java-version: '8'

    - name: 📦 시스템 의존성 설치
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-8-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev

    - name: 🔧 Python 의존성 설치
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython kivy[base] requests

    - name: 📱 Buildozer 초기화 및 APK 빌드
      run: |
        # buildozer.spec 파일 사용
        buildozer android ${{ github.event.inputs.build_type || 'debug' }}

    - name: 📂 빌드 결과 확인
      run: |
        ls -la bin/

    - name: 🚀 APK 파일 업로드
      uses: actions/upload-artifact@v4
      with:
        name: bible-mp3-player-${{ github.event.inputs.build_type || 'debug' }}-apk
        path: bin/*.apk

    - name: ✅ 빌드 완료 알림
      run: |
        echo "🎉 APK 빌드가 성공적으로 완료되었습니다!"
        echo "📱 APK 파일을 Artifacts에서 다운로드할 수 있습니다."
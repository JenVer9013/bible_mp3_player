name: ğŸµ ì„±ê²½ MP3 í”Œë ˆì´ì–´ APK ë¹Œë“œ

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•œ ì¤‘ìš”í•œ ì„¤ì •!
    inputs:
      build_type:
        description: 'ë¹Œë“œ íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ Python 3.8 ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: â˜• Java 8 ì„¤ì •
      uses: actions/setup-java@v3
      with:
        distribution: 'adopt'
        java-version: '8'

    - name: ğŸ“¦ ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-8-jdk python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo-dev cmake libffi-dev libssl-dev build-essential

    - name: ğŸ”§ Python ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython kivy[base] requests

    - name: ğŸ“± GitHub Actions ê¸°ë³¸ Android SDK ì‚¬ìš©
      uses: android-actions/setup-android@v3
      with:
        cmdline-tools-version: 8512546
        log-accepted-android-sdk-licenses: false
        
    - name: ğŸ”§ Android SDK ê²½ë¡œ ë° ë„êµ¬ ì„¤ì •
      run: |
        # GitHub Actionsì—ì„œ ì œê³µí•˜ëŠ” ê¸°ë³¸ Android SDK ì‚¬ìš©
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export ANDROID_SDK_HOME=$ANDROID_SDK_ROOT
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
        
        echo "=== Android SDK ì •ë³´ ==="
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        
        # í•„ìˆ˜ ì»´í¬ë„ŒíŠ¸ ì„¤ì¹˜
        echo "=== í•„ìˆ˜ Android ì»´í¬ë„ŒíŠ¸ ì„¤ì¹˜ ==="
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "build-tools;30.0.3" "platforms;android-30" "ndk;21.4.7075529"
        
        # AIDL ë„êµ¬ í™•ì¸
        echo "=== AIDL ë„êµ¬ í™•ì¸ ==="
        find $ANDROID_HOME -name "aidl" -type f 2>/dev/null | head -5
        
        if [ -f "$ANDROID_HOME/build-tools/30.0.3/aidl" ]; then
            echo "âœ… AIDL ë„êµ¬ ë°œê²¬: $ANDROID_HOME/build-tools/30.0.3/aidl"
            chmod +x $ANDROID_HOME/build-tools/30.0.3/aidl
        else
            echo "âš ï¸ 30.0.3 ë²„ì „ì— AIDL ì—†ìŒ. ë‹¤ë¥¸ ë²„ì „ì—ì„œ ë³µì‚¬ ì¤‘..."
            # ë‹¤ë¥¸ build-toolsì—ì„œ AIDL ì°¾ì•„ì„œ ë³µì‚¬
            AIDL_PATH=$(find $ANDROID_HOME/build-tools -name "aidl" -type f | head -1)
            if [ -n "$AIDL_PATH" ]; then
                echo "í•´ê²°ì±…: $AIDL_PATHë¥¼ 30.0.3ìœ¼ë¡œ ë³µì‚¬"
                cp "$AIDL_PATH" "$ANDROID_HOME/build-tools/30.0.3/aidl"
                chmod +x "$ANDROID_HOME/build-tools/30.0.3/aidl"
            fi
        fi
        
        # buildozerìš© í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/21.4.7075529" >> $GITHUB_ENV
        echo "PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/30.0.3" >> $GITHUB_ENV

    - name: ğŸ”„ AIDL ë„êµ¬ ìµœì¢… ê²€ì¦ ë° ëŒ€ì•ˆ ì„¤ì¹˜
      run: |
        echo "=== AIDL ë„êµ¬ ìµœì¢… ê²€ì¦ ì‹œì‘ ==="
        
        # í™˜ê²½ ë³€ìˆ˜ ë‹¤ì‹œ ì„¤ì • (ì„¸ì…˜ ê°„ ë³€ìˆ˜ ìœ ì§€)
        export ANDROID_HOME=$HOME/android-sdk
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/30.0.3
        
        # AIDL ë„êµ¬ ê²€ìƒ‰ ë° ê²€ì¦
        echo "1. ê¸°ë³¸ ìœ„ì¹˜ í™•ì¸: $ANDROID_HOME/build-tools/30.0.3/aidl"
        if [ -f "$ANDROID_HOME/build-tools/30.0.3/aidl" ]; then
            echo "âœ… AIDL ë„êµ¬ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
            chmod +x $ANDROID_HOME/build-tools/30.0.3/aidl
            $ANDROID_HOME/build-tools/30.0.3/aidl --version || echo "ë²„ì „ í™•ì¸ ì‹¤íŒ¨, í•˜ì§€ë§Œ íŒŒì¼ì€ ì¡´ì¬"
        else
            echo "âŒ 30.0.3ì—ì„œ AIDLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë²„ì „ í™•ì¸ ì¤‘..."
            
            # ë‹¤ë¥¸ build-tools ë²„ì „ í™•ì¸
            for version_dir in $ANDROID_HOME/build-tools/*/; do
                if [ -f "${version_dir}aidl" ]; then
                    echo "âœ… AIDL ë°œê²¬: ${version_dir}aidl"
                    chmod +x ${version_dir}aidl
                    # ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„±
                    ln -sf ${version_dir}aidl $ANDROID_HOME/build-tools/30.0.3/aidl
                    break
                fi
            done
        fi
        
        # ë§ˆì§€ë§‰ ìµœì¢… í™•ì¸
        if [ -f "$ANDROID_HOME/build-tools/30.0.3/aidl" ]; then
            echo "ğŸ‰ AIDL ë„êµ¬ ì¤€ë¹„ ì™„ë£Œ!"
        else
            echo "âš ï¸ AIDL ë„êµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  build-tools ë‚´ìš©:"
            find $ANDROID_HOME/build-tools -name "aidl" 2>/dev/null || echo "AIDL ë„êµ¬ê°€ ì „í˜€ ì—†ìŠµë‹ˆë‹¤."
        fi

    - name: ğŸ“± Buildozer ì´ˆê¸°í™” ë° APK ë¹Œë“œ
      run: |
        # í™˜ê²½ ë³€ìˆ˜ ë‹¤ì‹œ ì„¤ì •
        export ANDROID_HOME=$HOME/android-sdk
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        export ANDROID_NDK_HOME=$HOME/android-sdk/ndk/21.4.7075529
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/30.0.3
        
        # buildozer.spec íŒŒì¼ ì‚¬ìš©
        buildozer android ${{ github.event.inputs.build_type || 'debug' }}

    - name: ğŸ“‚ ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        ls -la bin/

    - name: ğŸš€ APK íŒŒì¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: bible-mp3-player-${{ github.event.inputs.build_type || 'debug' }}-apk
        path: bin/*.apk

    - name: âœ… ë¹Œë“œ ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "ğŸ‰ APK ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“± APK íŒŒì¼ì„ Artifactsì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
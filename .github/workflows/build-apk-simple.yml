# 2024ë…„ 8ì›” í…ŒìŠ¤íŠ¸ëœ ì„±ê³µì ì¸ Kivy APK ë¹Œë“œ ì›Œí¬í”Œë¡œìš°
# ì¶œì²˜: https://gist.github.com/zl475505/25245e8d28b13b3273e8bae1a63c4af2
name: ğŸµ ì„±ê²½ MP3 í”Œë ˆì´ì–´ APK ë¹Œë“œ (ê°„ë‹¨ ë²„ì „)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'ë¹Œë“œ íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build-android:
    name: ğŸ¤– Android APK ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ”§ Buildozer ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        echo "=== ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜ ==="
        sudo apt update
        sudo apt install -y git zip unzip python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo-dev cmake libffi-dev libssl-dev automake
        
        echo "=== Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ ==="
        pip install --user --upgrade Cython virtualenv
        pip install --user --upgrade buildozer
        
        echo "=== í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜ ==="
        if [ -f requirements.txt ]; then
            pip install --user -r requirements.txt
        fi

    - name: â˜• Java ê²½ë¡œ ì„¤ì • (ì¤‘ìš”!)
      run: |
        echo "=== Java í™˜ê²½ ì„¤ì • ==="
        export JAVA_HOME=/usr/lib/jvm/temurin-17-jdk-amd64
        sudo update-java-alternatives --set $JAVA_HOME
        export PATH=$JAVA_HOME/bin:$PATH
        
        echo "Java ë²„ì „ í™•ì¸:"
        java -version
        
        # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
        echo "PATH=$JAVA_HOME/bin:$PATH" >> $GITHUB_ENV

    - name: ğŸ“± APK ë¹Œë“œ ì‹¤í–‰
      run: |
        echo "=== Buildozer APK ë¹Œë“œ ì‹œì‘ ==="
        
        # ë¹Œë“œ ì „ í™˜ê²½ í™•ì¸
        echo "=== ë¹Œë“œ í™˜ê²½ í™•ì¸ ==="
        echo "Python ë²„ì „: $(python3 --version)"
        echo "Java ë²„ì „: $(java -version 2>&1 | head -1)"
        echo "Buildozer ë²„ì „: $(buildozer --version 2>/dev/null || echo 'ë²„ì „ í™•ì¸ ë¶ˆê°€')"
        echo "Working Directory: $(pwd)"
        echo "Contents: $(ls -la)"
        
        # main.py íŒŒì¼ í™•ì¸
        if [ ! -f main.py ]; then
            echo "âŒ main.py íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ Python íŒŒì¼ë“¤:"
            ls -la *.py || echo "Python íŒŒì¼ ì—†ìŒ"
            echo "ì„ì‹œë¡œ main.py ìƒì„±..."
            if [ -f kivy_main.py ]; then
                cp kivy_main.py main.py
                echo "âœ… kivy_main.pyë¥¼ main.pyë¡œ ë³µì‚¬"
            elif [ -f kivy_onedrive_main.py ]; then
                cp kivy_onedrive_main.py main.py
                echo "âœ… kivy_onedrive_main.pyë¥¼ main.pyë¡œ ë³µì‚¬"
            else
                echo "from kivy.app import App" > main.py
                echo "from kivy.uix.label import Label" >> main.py
                echo "class TestApp(App):" >> main.py
                echo "    def build(self):" >> main.py
                echo "        return Label(text='Hello World')" >> main.py
                echo "TestApp().run()" >> main.py
                echo "âœ… ê¸°ë³¸ main.py ìƒì„±"
            fi
        fi
        
        # buildozer.spec í™•ì¸
        if [ ! -f buildozer.spec ]; then
            echo "buildozer.spec íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸°í™”í•©ë‹ˆë‹¤..."
            buildozer init
        fi
        
        # buildozer ê¸°ë³¸ í…ŒìŠ¤íŠ¸
        echo "=== buildozer ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ==="
        
        # buildozer ì„¤ì¹˜ í™•ì¸
        echo "ë¹Œë“œì ì„¤ì¹˜ ìƒíƒœ:"
        which buildozer || echo "buildozer ëª…ë ¹ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
        buildozer --version || echo "buildozer ë²„ì „ í™•ì¸ ì‹¤íŒ¨"
        
        # buildozer ë„ì›€ë§ í™•ì¸
        echo "\nbuildozer ë„ì›€ë§ í…ŒìŠ¤íŠ¸:"
        buildozer --help | head -10 || echo "buildozer ë„ì›€ë§ ì‹¤íŒ¨"
        
        # PATH í™•ì¸
        echo "\ní˜„ì¬ PATH:"
        echo $PATH
        
        # Python íŒ¨í‚¤ì§€ í™•ì¸
        echo "\nì„¤ì¹˜ëœ Python íŒ¨í‚¤ì§€:"
        pip list | grep -E "(buildozer|cython|kivy)" || echo "ê´€ë ¨ íŒ¨í‚¤ì§€ ì—†ìŒ"
        
        # ì§€ì›ë˜ëŠ” í”Œë«í¼ í™•ì¸
        echo "\nbuildozer ì§€ì› í”Œë«í¼:"
        buildozer android --help 2>&1 | head -5 || echo "android í”Œë«í¼ ë„ì›€ë§ ì‹¤íŒ¨"
        
        # Android SDK ë¼ì´ì„¼ìŠ¤ ìˆ˜ë½
        echo "\n=== Android SDK ë¼ì´ì„¼ìŠ¤ ìˆ˜ë½ ==="
        export ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME

        # SDK ë¼ì´ì„¼ìŠ¤ ìˆ˜ë½ (ëª¨ë“  ë¼ì´ì„¼ìŠ¤ì— ëŒ€í•´ y ì‘ë‹µ)
        if [ -d "$ANDROID_HOME" ]; then
            echo "ê¸°ì¡´ Android SDK ë°œê²¬, ë¼ì´ì„¼ìŠ¤ ìˆ˜ë½ ì‹œë„..."
            (echo y; echo y; echo y; echo y; echo y; echo y) | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses 2>/dev/null || echo "ë¼ì´ì„¼ìŠ¤ ìˆ˜ë½ ì‹œë„ ì™„ë£Œ"
        else
            echo "Android SDKê°€ ì•„ì§ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ - buildozerê°€ ìë™ ì„¤ì¹˜í•  ì˜ˆì •"
        fi

        BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
        echo "\n=== APK ë¹Œë“œ ì‹œì‘ (BUILD_TYPE: $BUILD_TYPE) ==="
        
        # ë¹Œë“œ ì „ ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p .buildozer/logs
        
        # buildozer ëª…ë ¹ ì‹¤í–‰ (ë‹¨ê³„ë³„ ë””ë²„ê¹…)
        echo "buildozer android $BUILD_TYPE ì‹¤í–‰ ì¤‘..."
        
        # ì§ì ‘ ì‹¤í–‰í•˜ì—¬ ì˜¤ë¥˜ ìƒì„¸ ì •ë³´ í™•ì¸
        set +e  # ì˜¤ë¥˜ì—ë„ ê³„ì† ì§„í–‰
        buildozer -v android $BUILD_TYPE > build_output.log 2>&1
        BUILD_EXIT_CODE=$?
        set -e
        
        echo "\n=== buildozer ì¢…ë£Œ (exit code: $BUILD_EXIT_CODE) ==="
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "âœ… buildozer ë¹Œë“œ ì„±ê³µ!"
            echo "\n=== ì„±ê³µ ë¡œê·¸ ë§ˆì§€ë§‰ 20ì¤„ ==="
            if [ -f build_output.log ]; then
                tail -20 build_output.log
            fi
        else
            echo "âŒ buildozer ë¹Œë“œ ì‹¤íŒ¨! (exit code: $BUILD_EXIT_CODE)"
            
            echo "\n=== ë¹Œë“œ ì¶œë ¥ ë¡œê·¸ ==="
            if [ -f build_output.log ]; then
                LOG_SIZE=$(wc -l < build_output.log)
                echo "ë¹Œë“œ ì¶œë ¥ ë¡œê·¸ í¬ê¸°: $LOG_SIZE ì¤„"
                
                if [ $LOG_SIZE -gt 0 ]; then
                    echo "\n--- ì „ì²´ ë¡œê·¸ ë‚´ìš© ---"
                    cat build_output.log
                    echo "\n--- ë¡œê·¸ ë ---"
                else
                    echo "build_output.log íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."
                fi
            else
                echo "build_output.log íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            fi

            # ë¼ì´ì„¼ìŠ¤ ê´€ë ¨ ì˜¤ë¥˜ì¸ì§€ í™•ì¸í•˜ê³  ì¬ì‹œë„
            if [ -f build_output.log ] && grep -q "license.*not accepted\|Accept.*y/N" build_output.log; then
                echo "\n=== ë¼ì´ì„¼ìŠ¤ ì˜¤ë¥˜ ê°ì§€ - ì¬ì‹œë„ ==="
                if [ -d "$ANDROID_HOME/cmdline-tools/latest/bin" ]; then
                    echo "Android SDK Managerë¡œ ë¼ì´ì„¼ìŠ¤ ìˆ˜ë½ ì¬ì‹œë„..."
                    (yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses) 2>/dev/null || echo "ë¼ì´ì„¼ìŠ¤ ìˆ˜ë½ ì¬ì‹œë„ ì™„ë£Œ"

                    echo "ë¼ì´ì„¼ìŠ¤ ìˆ˜ë½ í›„ buildozer ì¬ì‹¤í–‰..."
                    buildozer android $BUILD_TYPE > build_output_retry.log 2>&1 && echo "âœ… ì¬ì‹œë„ ì„±ê³µ!" || echo "âŒ ì¬ì‹œë„ë„ ì‹¤íŒ¨"
                fi
            fi

            echo "\n=== ë‹¤ë¥¸ ë¡œê·¸ íŒŒì¼ ê²€ìƒ‰ ==="
            find . -name "*.log" -type f 2>/dev/null | head -10 || echo "ë¡œê·¸ íŒŒì¼ ì—†ìŒ"
            
            echo "\n=== .buildozer ë””ë ‰í† ë¦¬ í™•ì¸ ==="
            if [ -d .buildozer ]; then
                find .buildozer -type f -name "*.log" 2>/dev/null | head -5 || echo ".buildozer ë‚´ ë¡œê·¸ íŒŒì¼ ì—†ìŒ"
            else
                echo ".buildozer ë””ë ‰í† ë¦¬ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            fi
            
            exit $BUILD_EXIT_CODE
        fi

    - name: ğŸ“‚ ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        echo "=== ë¹Œë“œ ê²°ê³¼ í™•ì¸ ==="
        ls -la bin/ || echo "bin í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤."
        find . -name "*.apk" -type f || echo "APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

    - name: ğŸš€ APK íŒŒì¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: bible-mp3-player-${{ github.event.inputs.build_type || 'debug' }}-apk-simple
        path: bin/*.apk

    - name: âœ… ë¹Œë“œ ì™„ë£Œ ì•Œë¦¼
      if: success()
      run: |
        echo "ğŸ‰ APK ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“± APK íŒŒì¼ì„ Artifactsì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        
    - name: âŒ ë¹Œë“œ ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹… ì •ë³´
      if: failure()
      run: |
        echo "âŒ ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë””ë²„ê¹… ì •ë³´:"
        echo "=== buildozer.spec ë‚´ìš© ==="
        cat buildozer.spec || echo "buildozer.spec íŒŒì¼ ì—†ìŒ"
        echo "=== .buildozer ë¡œê·¸ ==="
        find .buildozer -name "*.log" -exec cat {} \; 2>/dev/null || echo "buildozer ë¡œê·¸ ì—†ìŒ"
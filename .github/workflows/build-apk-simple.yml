# 2024ë…„ 8ì›” í…ŒìŠ¤íŠ¸ëœ ì„±ê³µì ì¸ Kivy APK ë¹Œë“œ ì›Œí¬í”Œë¡œìš°
# ì¶œì²˜: https://gist.github.com/zl475505/25245e8d28b13b3273e8bae1a63c4af2
name: ğŸµ ì„±ê²½ MP3 í”Œë ˆì´ì–´ APK ë¹Œë“œ (ê°„ë‹¨ ë²„ì „)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'ë¹Œë“œ íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build-android:
    name: ğŸ¤– Android APK ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ”§ Buildozer ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        echo "=== ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜ ==="
        sudo apt update
        sudo apt install -y git zip unzip python3-pip autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo-dev cmake libffi-dev libssl-dev automake
        
        echo "=== Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ ==="
        pip install --user --upgrade Cython virtualenv
        pip install --user --upgrade buildozer
        
        echo "=== í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜ ==="
        if [ -f requirements.txt ]; then
            pip install --user -r requirements.txt
        fi

    - name: â˜• Java ê²½ë¡œ ì„¤ì • (ì¤‘ìš”!)
      run: |
        echo "=== Java í™˜ê²½ ì„¤ì • ==="
        export JAVA_HOME=/usr/lib/jvm/temurin-17-jdk-amd64
        sudo update-java-alternatives --set $JAVA_HOME
        export PATH=$JAVA_HOME/bin:$PATH
        
        echo "Java ë²„ì „ í™•ì¸:"
        java -version
        
        # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
        echo "PATH=$JAVA_HOME/bin:$PATH" >> $GITHUB_ENV

    - name: ğŸ“± APK ë¹Œë“œ ì‹¤í–‰
      run: |
        echo "=== Buildozer APK ë¹Œë“œ ì‹œì‘ ==="
        
        # buildozer.specì´ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
        if [ ! -f buildozer.spec ]; then
            echo "buildozer.spec íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸°í™”í•©ë‹ˆë‹¤..."
            buildozer init
        fi
        
        # ë¼ì´ì„ ìŠ¤ ìë™ ìŠ¹ì¸ìœ¼ë¡œ ë¹Œë“œ ì‹¤í–‰
        echo "=== APK ë¹Œë“œ (ë¼ì´ì„ ìŠ¤ ìë™ ìŠ¹ì¸) ==="
        yes | buildozer -v android ${{ github.event.inputs.build_type || 'debug' }}

    - name: ğŸ“‚ ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        echo "=== ë¹Œë“œ ê²°ê³¼ í™•ì¸ ==="
        ls -la bin/ || echo "bin í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤."
        find . -name "*.apk" -type f || echo "APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

    - name: ğŸš€ APK íŒŒì¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: bible-mp3-player-${{ github.event.inputs.build_type || 'debug' }}-apk-simple
        path: bin/*.apk

    - name: âœ… ë¹Œë“œ ì™„ë£Œ ì•Œë¦¼
      if: success()
      run: |
        echo "ğŸ‰ APK ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“± APK íŒŒì¼ì„ Artifactsì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        
    - name: âŒ ë¹Œë“œ ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹… ì •ë³´
      if: failure()
      run: |
        echo "âŒ ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë””ë²„ê¹… ì •ë³´:"
        echo "=== buildozer.spec ë‚´ìš© ==="
        cat buildozer.spec || echo "buildozer.spec íŒŒì¼ ì—†ìŒ"
        echo "=== .buildozer ë¡œê·¸ ==="
        find .buildozer -name "*.log" -exec cat {} \; 2>/dev/null || echo "buildozer ë¡œê·¸ ì—†ìŒ"